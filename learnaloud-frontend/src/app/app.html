<app-tutorial *ngIf="showTutorial" (startApp)="startAppFromTutorial()"></app-tutorial>

<div *ngIf="!showTutorial">
  @if (!isActivityMonitorRoute && !isDashboardRoute) {
    <div class="app-container">
      <header class="app-header">
        <div class="header-left">
          <h1>LearnAloud</h1>
          <span class="subtitle">Voice-Synchronized PDF Teaching Assistant</span>
        </div>
        @if (userName) {
          <div class="header-user">
            <span class="user-avatar">{{ userName.charAt(0).toUpperCase() }}</span>
            <span class="user-name">{{ userName }}</span>
            <button class="dashboard-link" (click)="openDashboard()" aria-label="Open dashboard">Dashboard</button>
            <button class="logout-btn" (click)="logout()" aria-label="Log out">Log out</button>
          </div>
        }
      </header>

      <div class="main-content three-column-layout">
        <!-- Left Sidebar -->
        <aside class="left-sidebar">
          <div class="sidebar-content">
            <div class="sidebar-header">
              <h2 class="sidebar-title">LearnAloud</h2>
            </div>
            
            <nav class="sidebar-nav">
              <button class="nav-item" (click)="startNewSession()" [class.active]="!pdfUrl" aria-label="Start a new session">
                <span class="nav-icon" aria-hidden="true"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></span>
                <span class="nav-label">New Session</span>
              </button>
              <button class="nav-item" (click)="toggleSessionHistory()" [class.active]="showSessionHistory" aria-label="Toggle session history" [attr.aria-expanded]="showSessionHistory">
                <span class="nav-icon" aria-hidden="true"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></span>
                <span class="nav-label">Session History</span>
              </button>
              <button class="nav-item" (click)="openDashboard()" aria-label="Open learning dashboard">
                <span class="nav-icon" aria-hidden="true"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg></span>
                <span class="nav-label">Dashboard</span>
              </button>
              <button class="nav-item" (click)="focusArxivSearch()" aria-label="Search for papers on ArXiv">
                <span class="nav-icon" aria-hidden="true"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></span>
                <span class="nav-label">Paper Search</span>
              </button>
              <button class="nav-item" (click)="openActivityMonitor()" aria-label="Open activity monitor">
                <span class="nav-icon" aria-hidden="true"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg></span>
                <span class="nav-label">Activity Monitor</span>
              </button>
            </nav>

            @if (sessionHistory.length > 0) {
              <div class="sidebar-chats">
                <h3 class="chats-title">Recent Sessions</h3>
                <div class="chats-list">
                  @for (session of sessionHistory.slice(0, 5); track session.id) {
                    <div class="chat-item" (click)="loadSession(session)">
                      <span class="chat-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg></span>
                      <div class="chat-info">
                        <p class="chat-name">{{ session.fileName.length > 25 ? session.fileName.substring(0, 25) + '...' : session.fileName }}</p>
                        <p class="chat-date">{{ session.date | date:'MMM d, h:mm a' }}</p>
                      </div>
                    </div>
                  }
                </div>
              </div>
            } @else {
              <div class="sidebar-chats empty">
                <div class="empty-chats">
                  <span class="empty-icon"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/><path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/></svg></span>
                  <p class="empty-text">No sessions yet</p>
                </div>
              </div>
            }

            <div class="sidebar-footer">
              <button class="footer-btn" (click)="openDashboard()" aria-label="Open settings">
                <span class="footer-icon" aria-hidden="true"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></span>
                <span>Settings</span>
              </button>
              @if (userName) {
                <div class="footer-user">
                  <span class="footer-avatar">{{ userName.charAt(0).toUpperCase() }}</span>
                  <span class="footer-name">{{ userName }}</span>
                </div>
              }
            </div>
          </div>
        </aside>

        <section class="pdf-section">
          @if (showModeSelector) {
            <div class="mode-selector-overlay" role="dialog" aria-label="Choose session mode" aria-modal="true">
              <div class="mode-selector">
                <h2 class="mode-selector-title" id="mode-selector-heading">Choose Session Mode</h2>
                <p class="mode-selector-subtitle">How would you like to learn this paper?</p>
                <div class="mode-selector-options" role="group" aria-labelledby="mode-selector-heading">
                  <button class="mode-option mode-tutor" (click)="selectTutorMode()" aria-label="Voice Tutor — one-on-one tutoring session with an AI tutor" autofocus>
                    <span class="mode-option-icon" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></span>
                    <span class="mode-option-label">Voice Tutor</span>
                    <span class="mode-option-desc">One-on-one tutoring session</span>
                  </button>
                  <button class="mode-option mode-debate" (click)="selectDebateMode()" aria-label="Author vs Reviewer — two AI agents debate the paper">
                    <span class="mode-option-icon" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></span>
                    <span class="mode-option-label">Author vs Reviewer</span>
                    <span class="mode-option-desc">Two agents debate the paper</span>
                  </button>
                </div>
              </div>
            </div>
          }

          @if (agentActivityMessage) {
            <div class="agent-activity-toast" role="status" aria-live="polite">
              <span class="agent-activity-spinner" aria-hidden="true"></span>
              <span>{{ agentActivityMessage }}</span>
            </div>
          }

          @if (paperStack.length > 1) {
            <div class="paper-breadcrumb">
              <button (click)="switchToMainPaper()" [class.active]="activePaperIndex === 0">
                {{ paperStack[0].fileName }}
              </button>
              @if (activePaperIndex > 0) {
                <span class="breadcrumb-arrow">&rarr;</span>
                <span class="breadcrumb-active">{{ paperStack[activePaperIndex].referenceLabel }}</span>
              }
            </div>
          }

          @if (pdfUrl) {
            <div class="pdf-viewer-container" [class.split-view]="showPreviewPanel">
              <div class="main-viewer">
                <app-pdf-viewer
                  [pdfUrl]="getActivePdfUrl()"
                  [sessionId]="getActiveSessionId()"
                  (pageChanged)="onPageChanged($event)"
                ></app-pdf-viewer>
              </div>
              @if (showPreviewPanel && previewPaperIndex !== null) {
                <div class="split-handle" (mousedown)="onSplitHandleMouseDown($event)"></div>
                <div class="preview-panel" [style.flex]="'0 0 ' + previewPanelWidth + '%'">
                  <div class="preview-header">
                    <h3>{{ getPreviewPaperName() }}</h3>
                    <div class="preview-actions">
                      <button class="preview-make-active" (click)="switchToPreviewPaper()" aria-label="Switch to this paper as the active document">Make Active</button>
                      <button class="preview-close" (click)="closePreview()" aria-label="Close paper preview">&times;</button>
                    </div>
                  </div>
                  <app-pdf-viewer
                    [pdfUrl]="getPreviewPdfUrl()"
                    [sessionId]="getPreviewSessionId()"
                    [isPreview]="true"
                  ></app-pdf-viewer>
                </div>
              }
            </div>
          } @else {
            <div class="upload-area">
              @if (lastSession) {
                <div class="welcome-back">
                  <h2 class="welcome-back-title">Welcome back, {{ userName }}!</h2>
                  <div class="welcome-back-card">
                    <h3 class="welcome-back-label">Your last session</h3>
                    <p class="welcome-back-file">{{ lastSession.fileName }}</p>
                    <p class="welcome-back-date">{{ lastSession.date | date:'MMM d, y \'at\' h:mm a' }}</p>
                    <p class="welcome-back-summary">{{ lastSession.topicSummary }}</p>
                    <p class="welcome-back-meta">{{ lastSession.transcript.length }} messages exchanged</p>
                  </div>
                  <p class="welcome-back-hint">Upload the same PDF to continue where you left off, or choose a new one.</p>
                  <label class="upload-btn" for="pdfInput" role="button" tabindex="0" aria-label="Upload a PDF file">Upload PDF</label>
                  <input
                    id="pdfInput"
                    type="file"
                    accept="application/pdf"
                    (change)="onFileSelected($event)"
                    hidden
                    aria-label="Choose PDF file to upload"
                  />

                  @if (sessionHistory.length > 1) {
                    <div class="all-sessions">
                      <h3 class="all-sessions-title">All Sessions</h3>
                      <div class="all-sessions-list">
                        @for (session of sessionHistory; track session.id) {
                          <div class="all-sessions-item" [class.all-sessions-item-expanded]="expandedSessionId === session.id" (click)="toggleSessionExpand(session.id)">
                            <div class="all-sessions-item-row">
                              <span class="all-sessions-time">{{ session.date | date:'MMM d, h:mm a' }}</span>
                              <span class="all-sessions-file">{{ session.fileName }}</span>
                              <span class="all-sessions-count">{{ session.transcript.length }} msg</span>
                            </div>
                            <p class="all-sessions-summary">{{ session.topicSummary }}</p>
                            @if (expandedSessionId === session.id) {
                              <div class="all-sessions-transcript">
                                @for (entry of session.transcript.slice(0, 8); track $index) {
                                  <div class="all-sessions-entry" [class.session-entry-you]="entry.sender === 'you'">
                                    <span class="transcript-sender">{{ entry.sender === 'you' ? 'You' : 'Tutor' }}:</span>
                                    {{ entry.text.length > 200 ? entry.text.substring(0, 200) + '...' : entry.text }}
                                  </div>
                                }
                                @if (session.transcript.length > 8) {
                                  <div class="session-more">+ {{ session.transcript.length - 8 }} more messages</div>
                                }
                              </div>
                            }
                          </div>
                        }
                      </div>
                    </div>
                  }
                </div>
              } @else {
                <div class="upload-prompt">
                  <p class="upload-icon">&#128196;</p>
                  <p>Upload a PDF to get started</p>
                  <label class="upload-btn" for="pdfInput" role="button" tabindex="0" aria-label="Choose a PDF file to upload">Choose PDF File</label>
                  <input
                    id="pdfInput"
                    type="file"
                    accept="application/pdf"
                    (change)="onFileSelected($event)"
                    hidden
                    aria-label="Choose PDF file to upload"
                  />
                </div>
              }
            </div>
          }
        </section>

        <!-- Desktop controls sidebar -->
        @if (!isMobileDevice) {
          <aside class="controls-section">
            <div class="controls-panel">
              <h2>Controls</h2>

              @if (pdfUrl) {
                <p class="file-name">{{ uploadedFileName }}</p>

                <!-- Voice controls -->
                <div class="voice-controls">
                  @if (!isVoiceConnected && !isVoiceConnecting) {
                    <button
                      class="voice-btn voice-start"
                      (click)="startVoiceSession()"
                      aria-label="Start voice session with AI tutor"
                    >
                      Start Voice Session
                    </button>
                  }

                  @if (isVoiceConnecting) {
                    <button class="voice-btn voice-start" disabled aria-label="Connecting to voice session" aria-busy="true">
                      Connecting...
                    </button>
                  }

                  @if (isVoiceConnected) {
                    <div class="voice-active" [class.voice-paused]="isPaused" role="status" aria-live="polite">
                      <span class="voice-indicator" aria-hidden="true"></span>
                      <span>{{ isPaused ? 'Session Paused' : (isDebateMode ? 'Debate Active' : 'Voice Active') }}</span>
                    </div>
                    @if (isDebateMode) {
                      @if (debateActiveSpeaker) {
                        <div class="debate-speaker-indicator" [class.debate-speaker-author]="debateActiveSpeaker === 'author'" [class.debate-speaker-reviewer]="debateActiveSpeaker === 'reviewer'" role="status" aria-live="polite">
                          <span class="debate-speaker-dot" aria-hidden="true"></span>
                          <span>{{ debateActiveSpeaker === 'author' ? 'Author speaking' : 'Reviewer speaking' }}</span>
                        </div>
                      }
                      <div class="debate-turn-controls" role="group" aria-label="Debate turn controls">
                        <button class="debate-btn debate-btn-reviewer" (click)="askReviewer()" aria-label="Ask the reviewer to critique the author's points">
                          Ask Reviewer
                        </button>
                        <button class="debate-btn debate-btn-author" (click)="askAuthor()" aria-label="Ask the author to respond to the reviewer's critique">
                          Ask Author
                        </button>
                      </div>
                      <p class="debate-hint" aria-label="You can also say reviewer or author to switch speakers">Say "reviewer" or "author" to switch, or use the buttons</p>
                    }
                    <div class="voice-action-row" role="group" aria-label="Voice session controls">
                      <button
                        class="voice-btn voice-pause"
                        (click)="togglePause()"
                        [attr.aria-label]="isPaused ? 'Resume voice session' : 'Pause voice session'"
                      >
                        {{ isPaused ? 'Resume' : 'Pause' }}
                      </button>
                      <button
                        class="voice-btn voice-mic"
                        (click)="toggleMic()"
                        [disabled]="isPaused"
                        [attr.aria-label]="isMicMuted ? 'Unmute your microphone' : 'Mute your microphone'"
                      >
                        {{ isMicMuted ? 'Unmute Mic' : 'Mute Mic' }}
                      </button>
                      <button
                        class="voice-btn voice-disconnect"
                        (click)="disconnectVoice()"
                        aria-label="Disconnect voice session"
                      >
                        Disconnect
                      </button>
                    </div>
                    @if (sessionId) {
                      <button class="handover-btn" (click)="showContinueOnPhone()" aria-label="Continue this session on your phone via QR code">Continue on Phone</button>
                    }
                  }

                  @if (voiceError) {
                    <p class="voice-error" role="alert">{{ voiceError }}</p>
                  }
                </div>

                <hr class="controls-divider" />

                <button
                  class="monitor-btn"
                  (click)="openActivityMonitor()"
                  aria-label="Open activity monitor in new window"
                >
                  Activity Monitor
                </button>
                <label class="upload-btn reupload" for="pdfInputAlt" role="button" tabindex="0" aria-label="Upload a different PDF file">Upload Different PDF</label>
                <input
                  id="pdfInputAlt"
                  type="file"
                  accept="application/pdf"
                  (change)="onFileSelected($event)"
                  hidden
                  aria-label="Choose a different PDF file to upload"
                />
              }

              @if (statusMessage) {
                <p class="status" role="status" aria-live="polite">{{ statusMessage }}</p>
              }

              @if (mcpSearching) {
                <div class="mcp-search-indicator" role="status" aria-live="polite">
                  <span class="mcp-search-spinner" aria-hidden="true"></span>
                  <span>Searching ArXiv for "{{ mcpSearchQuery }}"...</span>
                </div>
              }
            </div>

            @if (pdfUrl) {
              <!-- PDF References -->
              @if (pdfReferences.length > 0) {
                <div class="references-panel">
                  <div class="references-header" (click)="toggleReferences()" role="button" tabindex="0" [attr.aria-expanded]="showReferences" aria-label="Toggle PDF references list">
                    <h3>PDF References ({{ pdfReferences.length }})</h3>
                    <span class="references-toggle" aria-hidden="true">{{ showReferences ? '▾' : '▸' }}</span>
                  </div>
                  @if (showReferences) {
                    <div class="references-list">
                      @for (ref of pdfReferences; track ref.number) {
                        <div class="reference-item">
                          <span class="reference-number">[{{ ref.number }}]</span>
                          <span class="reference-text">{{ ref.text.replace('[' + ref.number + '] ', '') }}</span>
                          <button class="reference-search-btn" (click)="searchReference(ref)" [disabled]="isAgentLoading" title="Search ArXiv for this paper">
                            Search
                          </button>
                        </div>
                      }
                    </div>
                  }
                </div>
              } @else if (referencesLoading) {
                <div class="references-panel">
                  <p class="references-loading">Loading references...</p>
                </div>
              }

              <!-- Agent Tools (excluding citation lookup) -->
              <div class="agent-tools">
                <div class="agent-tools-header">
                  <h3>Agent Tools</h3>
                  @if (mcpConnected) {
                    <button class="mcp-status" (click)="toggleMcpTools()" title="MCP server connected — click to view tools">
                      <span class="mcp-dot"></span>
                      MCP Connected
                    </button>
                  }
                </div>
                @if (showMcpTools && mcpTools.length > 0) {
                  <div class="mcp-tools-list">
                    <p class="mcp-tools-title">Available MCP Tools</p>
                    @for (tool of mcpTools; track tool.name) {
                      <div class="mcp-tool-item">
                        <span class="mcp-tool-name">{{ tool.name }}</span>
                        <span class="mcp-tool-desc">{{ tool.description }}</span>
                      </div>
                    }
                  </div>
                }
                <div class="agent-tool-row">
                  <input
                    type="text"
                    class="agent-input"
                    placeholder="Search ArXiv..."
                    [(ngModel)]="arxivQuery"
                    (keyup.enter)="triggerArxivSearch()"
                    aria-label="Search ArXiv for academic papers"
                  />
                  <button class="agent-tool-btn" (click)="triggerArxivSearch()" [disabled]="isAgentLoading" aria-label="Submit ArXiv search">
                    Search
                  </button>
                </div>
              </div>
            }

            <!-- Transcript (collapsible) -->
            @if (isVoiceConnected && transcriptEntries.length > 0) {
              <div class="references-panel transcript-panel" role="region" aria-label="Voice transcript">
                <div class="references-header" (click)="toggleTranscript()" role="button" tabindex="0" [attr.aria-expanded]="showTranscript" aria-label="Toggle voice transcript">
                  <h3>Transcript ({{ transcriptEntries.length }})</h3>
                  <span class="references-toggle" aria-hidden="true">{{ showTranscript ? '&#9662;' : '&#9656;' }}</span>
                </div>
                @if (showTranscript) {
                  <div class="transcript-messages">
                    @for (entry of transcriptEntries; track entry.id) {
                      <div class="transcript-entry"
                        [class.transcript-you]="entry.sender === 'you'"
                        [class.transcript-agent]="entry.sender === 'agent' && !entry.role"
                        [class.transcript-author]="entry.role === 'author' && entry.sender === 'agent'"
                        [class.transcript-reviewer]="entry.role === 'reviewer' && entry.sender === 'agent'"
                        [class.transcript-partial]="!entry.isFinal">
                        <span class="transcript-sender"
                          [class.sender-author]="entry.role === 'author'"
                          [class.sender-reviewer]="entry.role === 'reviewer'">
                          {{ entry.sender === 'you' ? 'You' : (entry.role === 'author' ? 'Author' : (entry.role === 'reviewer' ? 'Reviewer' : 'Tutor')) }}:
                        </span>
                        {{ entry.text }}
                      </div>
                    }
                  </div>
                }
              </div>
            }

            <!-- Agent Results with notification -->
            <div class="agent-results-wrapper" [class.has-new-results]="hasNewResults" (click)="clearNewResults()">
              @if (hasNewResults) {
                <div class="new-results-badge">New results</div>
              }
              <app-agent-results-panel
                [results]="agentResults"
                [isLoading]="isAgentLoading"
                (downloadPaper)="onDownloadPaper($event)"
              ></app-agent-results-panel>
            </div>
          </aside>
        }

        <!-- Mobile floating toolbar -->
        @if (isMobileDevice && pdfUrl) {
          <div class="mobile-toolbar" role="toolbar" aria-label="Voice session controls">
            @if (isVoiceConnected) {
              <div class="mobile-status" role="status" aria-live="polite">
                <span class="voice-indicator" aria-hidden="true"></span>
                <span class="mobile-status-text">{{ isPaused ? 'Paused' : 'Live' }}</span>
              </div>
              <button class="mobile-btn" (click)="toggleMic()" [disabled]="isPaused" [class.mobile-btn-active]="isMicMuted" [attr.aria-label]="isMicMuted ? 'Unmute your microphone' : 'Mute your microphone'">
                {{ isMicMuted ? 'Unmute' : 'Mute' }}
              </button>
              <button class="mobile-btn" (click)="togglePause()" [attr.aria-label]="isPaused ? 'Resume voice session' : 'Pause voice session'">
                {{ isPaused ? 'Resume' : 'Pause' }}
              </button>
              @if (isDebateMode) {
                <button class="mobile-btn mobile-btn-reviewer" (click)="askReviewer()" aria-label="Ask the reviewer to critique">Reviewer</button>
                <button class="mobile-btn mobile-btn-author" (click)="askAuthor()" aria-label="Ask the author to respond">Author</button>
              }
              <button class="mobile-btn mobile-btn-transcript" (click)="toggleMobileTranscript()" aria-label="Open transcript chat">
                Chat
                @if (transcriptEntries.length > 0) {
                  <span class="mobile-badge" aria-label="{{ transcriptEntries.length }} messages">{{ transcriptEntries.length }}</span>
                }
              </button>
              <button class="mobile-btn mobile-btn-danger" (click)="disconnectVoice()" aria-label="End voice session">
                End
              </button>
            } @else {
              <button class="mobile-btn mobile-btn-start" (click)="startVoiceSession()" [disabled]="isVoiceConnecting" aria-label="Start voice tutor session">
                {{ isVoiceConnecting ? 'Connecting...' : 'Start Tutor' }}
              </button>
            }
          </div>

          @if (micError) {
            <div class="mobile-mic-error">{{ micError }}</div>
          }

          <!-- Mobile transcript overlay -->
          @if (showMobileTranscript && transcriptEntries.length > 0) {
            <div class="mobile-transcript-overlay" (click)="toggleMobileTranscript()">
              <div class="mobile-transcript-panel" (click)="$event.stopPropagation()">
                <div class="mobile-transcript-header">
                  <h3>Transcript</h3>
                  <button class="mobile-transcript-close" (click)="toggleMobileTranscript()" aria-label="Close transcript">&times;</button>
                </div>
                <div class="mobile-transcript-messages">
                  @for (entry of transcriptEntries; track entry.id) {
                    <div class="transcript-entry"
                      [class.transcript-you]="entry.sender === 'you'"
                      [class.transcript-agent]="entry.sender === 'agent' && !entry.role"
                      [class.transcript-author]="entry.role === 'author' && entry.sender === 'agent'"
                      [class.transcript-reviewer]="entry.role === 'reviewer' && entry.sender === 'agent'"
                      [class.transcript-partial]="!entry.isFinal">
                      <span class="transcript-sender"
                        [class.sender-author]="entry.role === 'author'"
                        [class.sender-reviewer]="entry.role === 'reviewer'">
                        {{ entry.sender === 'you' ? 'You' : (entry.role === 'author' ? 'Author' : (entry.role === 'reviewer' ? 'Reviewer' : 'Tutor')) }}:
                      </span>
                      {{ entry.text }}
                    </div>
                  }
                </div>
              </div>
            </div>
          }
        }
      </div>
    </div>
  }
  <router-outlet></router-outlet>

  @if (showQrModal) {
    <div class="qr-modal-overlay" (click)="closeQrModal()" role="dialog" aria-label="Continue on phone" aria-modal="true">
      <div class="qr-modal" (click)="$event.stopPropagation()">
        <h2>Continue on Phone</h2>
        <p class="qr-subtitle">Scan this QR code to continue the session on your phone</p>
        <img class="qr-code-image" [src]="qrCodeDataUrl" alt="QR code to continue session on phone" width="256" height="256" />
        <div class="qr-url-container">
          <input class="qr-url-input" type="text" [value]="handoverUrl" readonly aria-label="Session handover URL" />
          <button class="qr-copy-btn" (click)="copyUrlToClipboard()" aria-label="Copy handover URL to clipboard">Copy</button>
        </div>
        <p class="qr-note">Both devices must be on the same WiFi network</p>
        <button class="qr-close-btn" (click)="closeQrModal()" aria-label="Close QR code dialog">Close</button>
      </div>
    </div>
  }
</div>
